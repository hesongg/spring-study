### 스프링 DB - 데이터 접근 활용 기술

#### Reference) 
	* 스프링 DB 2편 - 데이터 접근 활용 기술 (인프런 김영한님 강의 학습한 내용 정리)

#### 작성 코드
- https://github.com/hesongg/Spring-DB-Itemservice
	
<br>


### 데이터 접근 기술 - 시작


<br>

#### 데이터 접근 기술 진행 방식 소개

- 앞으로 실무에서 주로 사용하는 다음과 같은 다양한 데이터 접근 기술들을 학습

- 적용 데이터 접근 기술
	- JdbcTemplate
	- MyBatis
	- JPA, Hibernate
	- 스프링 데이터 JPA
	- Querydsl
	
- 여기에는 크게 2가지 분류가 있다.
	- ```SQLMapper```
		- JdbcTemplate
		- MyBatis
	
	- ```ORM 관련 기술```
		- JPA, Hibernate
		- 스프링 데이터 JPA
		- Querydsl
		
- SQL Mapper 주요기능
	- 개발자는 SQL만 작성하면 해당 SQL의 결과를 객체로 편리하게 매핑해준다.
	- JDBC를 직접 사용할 때 발생하는 여러가지 중복을 제거해주고, 기타 개발자에게 여러가지 편리한 기능을 제공한다

- ORM 주요 기능
	- JdbcTemplate이나 MyBatis 같은 SQL 매퍼 기술은 SQL을 개발자가 직접 작성해야 하지만, 
		JPA를 사용하면 기본적인 SQL은 JPA가 대신 작성하고 처리해준다. 
		- 개발자는 저장하고 싶은 객체를 마치 자바 컬렉션에 저장하고 조회하듯이 사용하면 ORM 기술이 데이터베이스에 해당 객체를 저장하고 조회해준다.
	
	- JPA는 자바 진영의 ORM 표준이고, Hibernate(하이버네이트)는 JPA에서 가장 많이 사용하는 구현체이다. 
		- 자바에서 ORM을 사용할 때는 JPA 인터페이스를 사용하고, 그 구현체로 하이버네이트를 사용한다고 생각하면 된다.
	
	- 스프링 데이터 JPA, Querydsl은 JPA를 더 편리하게 사용할 수 있게 도와주는 프로젝트이다. 
		- 실무에서는 JPA를 사용하면 이 프로젝트도 꼭! 함께 사용하는 것이 좋다.

<br>

#### 데이터 접근 기술 - 시작

- 프로젝트 구조 설명 - 설정
	- ```MemoryConfig```
		- 서비스, 리포지토리를 스프링 빈으로 등록, 생성자를 통해 의존관계를 주입
		
		- 서비스와 리포지토리는 구현체를 편리하게 변경하기 위해, 이렇게 수동으로 빈을 등록함
		
		- 컨트롤러는 컴포넌트 스캔을 사용
		
	- ```TestDataInit```
		- 애플리케이션을 실행할 때 초기 데이터를 저장
		
		- 리스트에서 데이터가 잘 나오는지 편리하게 확인할 용도로 사용
		
		- ```@EventListener(ApplicationReadyEvent.class)```
			- 스프링 컨테이너가 완전히 초기화를 다 끝내고, 실행 준비가 되었을 때 발생하는 이벤트이다. 
				- 스프링이 이 시점에 해당 애노테이션이 붙은 ```initData()``` 메서드를 호출해준다.
			
			- 참고로 이 기능 대신 ```@PostConstruct``` 를 사용할 경우 AOP 같은 부분이 아직 다 처리되지 않은 시점에 호출될 수 있기 때문에, 
				간혹 문제가 발생할 수 있다.
				- 예를 들어서 ```@Transactional``` 과 관련된 AOP가 적용되지 않은 상태로 호출될 수 있다.
			
			- ```@EventListener(ApplicationReadyEvent.class)``` 는 AOP를 포함한 스프링 컨테이너가 완전히 초기화 된 이후에 호출되기 때문에 이런 문제가 발생하지 않는다.
			
	- ```ItemServiceApplication```
		
		- ```@Import(MemoryConfig.class)``` : 앞서 설정한 ```MemoryConfig``` 를 설정 파일로 사용한다
			
		- ```scanBasePackages = "hello.itemservice.web"``` : 여기서는 컨트롤러만 컴포넌트 스캔을 사용하고, 나머지는 직접 수동 등록한다. 
			- 그래서 컴포넌트 스캔 경로를 ```hello.itemservice.web``` 하위로 지정
		
		- ```@Profile("local")``` : 특정 프로필의 경우에만 해당 스프링 빈을 등록한다. 
			- 여기서는 ```local``` 이라는 이름의 프로필이 사용되는 경우에만 ```testDataInit``` 이라는 스프링 빈을 등록한다. 
			- 이 빈은 앞서 본 것인데, 편의상 초기 데이터를 만들어서 저장하는 빈이다
			
<br>


- 프로필

	- 스프링은 로딩 시점에 ```application.properties``` 의 ```spring.profiles.active``` 속성을 읽어서 프로필로 사용
	
	- 프로필은 로컬(나의 PC), 운영 환경, 테스트 실행 등등 다양한 환경에 따라서 다른 설정을 할 때 사용하는 정보이다.
	
	- 예를 들어서 로컬PC에서는 로컬 PC에 설치된 데이터베이스에 접근해야 하고, 운영 환경에서는 운영 데이터베이스에 접근해야 한다면 서로 설정 정보가 달라야 한다. 
		- 심지어 환경에 따라서 다른 스프링 빈을 등록해야 할 수 도 있다. 
		
		- 프로필을 사용하면 이런 문제를 깔끔하게 해결할 수 있다.
	
	<br>
	
	- main 프로필 : ```/src/main/resources``` 하위의 ```application.properties```
		
		```properties
		spring.profiles.active=local
		```
		
		- 이 위치의 ```application.properties``` 는 ```/src/main``` 하위의 자바 객체를 실행할 때 (주로 ```main()``` ) 동작하는 스프링 설정이다. 
			- ```spring.profiles.active=local``` 이라고 하면 스프링은 ```local``` 이라는 프로필로 동작한다. 
			- 따라서 직전에 설명한 ```@Profile("local")``` 가 동작하고, ```testDataInit``` 가 스프링 빈으로 등록된다

		- 참고로 프로필을 지정하지 않으면 디폴트( ```default``` ) 프로필이 실행된다.
	
	<br>
	
	- test 프로필 : ```/src/test/resources``` 하위의 ```application.properties```
		
		```properties
		spring.profiles.active=test
		```
		
		- 이 위치의 ```application.properties``` 는 ```/src/test``` 하위의 자바 객체를 실행할 때 동작하는 스프링 설정이다.
			- 주로 테스트 케이스를 실행할 때 동작한다.
		
			- ```spring.profiles.active=test``` 로 설정하면 스프링은 ```test``` 라는 프로필로 동작한다. 
				- 이 경우 직전에 설명한 ```@Profile("local"```) 는 프로필 정보가 맞지 않아서 동작하지 않는다. 
				- 따라서 ```testDataInit``` 이라는 스프링 빈도 등록되지 않고, 초기 데이터도 추가하지 않는다.
		
	<br>
	
	- 프로필 기능을 사용해서 스프링으로 웹 애플리케이션을 로컬( ```local``` )에서 직접 실행할 때는 ```testDataInit``` 이 스프링 빈으로 등록된다. 
		- 따라서 등록한 초기화 데이터를 편리하게 확인할 수 있다.
	
	- 초기화 데이터 덕분에 편리한 점도 있지만, 테스트 케이스를 실행할 때는 문제가 될 수 있다. 
		- 테스트에서 이런 데이터가 들어있다면 오류가 발생할 수 있다.
		- 예를 들어서 데이터를 하나 저장하고 전체 카운트를 확인하는데 1이 아니라 ```testDataInit``` 때문에 데이터가 2건 추가되어서 3이 되는 것이다.
	
	- 프로필 기능 덕분에 테스트 케이스에서는 ```test``` 프로필이 실행된다. 
		- 따라서 ```TestDataInit``` 는 스프링	빈으로 추가되지 않고, 따라서 초기 데이터도 추가되지 않는다.

	<br>
	
	- 참고
		- 프로필에 대한 스프링 부트 공식 메뉴얼은 다음을 참고
			- https://docs.spring.io/spring-boot/docs/current/reference/html/features.html#features.profiles

<br>

#### 데이터베이스 테이블 생성

- H2 데이터베이스에 ```item``` 테이블을 생성
	- ```generated by default as identity```
		- ```identity``` 전략이고 하는데, 기본 키 생성을 데이터베이스에 위임하는 방법이다. 
			- MySQL의 AutoIncrement와 같은 방법이다.
		
		- 여기서 PK로 사용되는 id 는 개발자가 직접 지정하는 것이 아니라 비워두고 저장하면 된다. 
			- 그러면 데이터베이스가 순서대로 증가하는 값을 사용해서 넣어준다.\

<br>

- 참고 - 권장하는 식별자 선택 전략
	- 데이터베이스 기본 키는 다음 3가지 조건을 모두 만족해야 한다.
		- 1. null 값은 허용하지 않는다.
		- 2. 유일해야 한다.
		- 3. 변해선 안 된다.
	
	- 테이블의 기본 키를 선택하는 전략은 크게 2가지가 있다.
		- 자연 키(natural key)
			- 비즈니스에 의미가 있는 키
			- 예: 주민등록번호, 이메일, 전화번호
		
		- 대리 키(surrogate key)
			- 비즈니스와 관련 없는 임의로 만들어진 키, 대체 키로도 불린다.
			- 예: 오라클 시퀀스, auto_increment, identity, 키생성 테이블 사용
	
	<br>
	
	- 자연 키보다는 대리 키를 권장한다
		- 자연 키와 대리 키는 일장 일단이 있지만 될 수 있으면 대리 키의 사용을 권장한다. 
		- 예를 들어 자연 키인 전화번호를 기본 키로 선택한다면 그 번호가 유일할 수는 있지만, 
			전화번호가 없을 수도 있고 전화번호가 변경될 수도 있다. 
			- 따라서 기본 키로 적당하지 않다. 
		- 문제는 주민등록번 호처럼 그럴듯하게 보이는 값이다.
			- 이 값은 null 이 아니고 유일하며 변하지 않는다는 3가지 조건을 모두 만족하는 것 같다. 
			- 하지만 현실과	비즈니스 규칙은 생각보다 쉽게 변한다. 주민등록번호 조차도 여러 가지 이유로 변경될 수 있다. 
